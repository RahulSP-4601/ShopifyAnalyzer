// ShopIQ Database Schema
// Prisma ORM for Shopify Analytics App

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// STORE & AUTH
// ============================================

model Store {
  id String @id @default(cuid())

  // Shopify identifiers
  shopifyId String  @unique
  domain    String  @unique // my-store.myshopify.com
  name      String
  email     String?
  currency  String  @default("USD")
  timezone  String  @default("UTC")

  // Auth
  accessToken String
  scope       String

  // Sync status
  syncStatus     SyncStatus @default(PENDING)
  lastSyncedAt   DateTime?
  ordersCount    Int        @default(0)
  productsCount  Int        @default(0)
  customersCount Int        @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders        Order[]
  products      Product[]
  customers     Customer[]
  conversations Conversation[]
  reports       Report[]
  syncLogs      SyncLog[]
}

enum SyncStatus {
  PENDING
  SYNCING
  COMPLETED
  FAILED
}

model SyncLog {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  entity       String // "orders" | "products" | "customers"
  status       String // "started" | "in_progress" | "completed" | "failed"
  totalCount   Int?
  syncedCount  Int     @default(0)
  errorMessage String?

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([storeId])
}

// ============================================
// PRODUCTS
// ============================================

model Product {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Shopify data
  shopifyId   String
  title       String
  handle      String?
  productType String?
  vendor      String?
  status      String  @default("active")

  // Pricing
  price          Decimal? @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)
  costPerItem    Decimal? @db.Decimal(10, 2)

  // Inventory
  totalInventory Int @default(0)

  // Images
  imageUrl String?

  // Timestamps
  shopifyCreatedAt DateTime?
  shopifyUpdatedAt DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  variants  ProductVariant[]
  lineItems LineItem[]

  @@unique([storeId, shopifyId])
  @@index([storeId])
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  shopifyId         String
  title             String
  sku               String?
  price             Decimal  @db.Decimal(10, 2)
  compareAtPrice    Decimal? @db.Decimal(10, 2)
  costPerItem       Decimal? @db.Decimal(10, 2)
  inventoryQuantity Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lineItems LineItem[]

  @@unique([productId, shopifyId])
}

// ============================================
// CUSTOMERS
// ============================================

model Customer {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Shopify data
  shopifyId String
  email     String?
  firstName String?
  lastName  String?
  phone     String?

  // Location
  city     String?
  province String?
  country  String?

  // Stats
  ordersCount Int     @default(0)
  totalSpent  Decimal @default(0) @db.Decimal(10, 2)

  // Marketing
  acceptsMarketing Boolean @default(false)

  // Tags
  tags String?

  // Timestamps
  shopifyCreatedAt DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  orders Order[]

  @@unique([storeId, shopifyId])
  @@index([storeId])
  @@index([email])
}

// ============================================
// ORDERS
// ============================================

model Order {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Shopify data
  shopifyId   String
  orderNumber Int
  name        String // e.g., "#1001"

  // Financials
  totalPrice     Decimal @db.Decimal(10, 2)
  subtotalPrice  Decimal @db.Decimal(10, 2)
  totalTax       Decimal @default(0) @db.Decimal(10, 2)
  totalDiscounts Decimal @default(0) @db.Decimal(10, 2)
  totalShipping  Decimal @default(0) @db.Decimal(10, 2)
  currency       String  @default("USD")

  // Status
  financialStatus   String?
  fulfillmentStatus String?

  // Customer
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  customerEmail String?

  // Source
  sourceName String?

  // Location
  shippingCity     String?
  shippingProvince String?
  shippingCountry  String?

  // Timestamps
  shopifyCreatedAt DateTime
  shopifyUpdatedAt DateTime?
  cancelledAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  lineItems LineItem[]

  @@unique([storeId, shopifyId])
  @@index([storeId])
  @@index([shopifyCreatedAt])
  @@index([customerId])
}

model LineItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Product reference
  productId String?
  product   Product?        @relation(fields: [productId], references: [id])
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  // Shopify IDs
  shopifyProductId String?
  shopifyVariantId String?

  // Item details
  title         String
  variantTitle  String?
  sku           String?
  quantity      Int
  price         Decimal @db.Decimal(10, 2)
  totalDiscount Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

// ============================================
// CONVERSATIONS & MESSAGES
// ============================================

model Conversation {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  title String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]

  @@index([storeId])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  role    MessageRole
  content String      @db.Text

  // For assistant messages
  queryData Json?

  createdAt DateTime @default(now())

  @@index([conversationId])
}

enum MessageRole {
  USER
  ASSISTANT
}

// ============================================
// REPORTS
// ============================================

model Report {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  type  ReportType
  title String

  // Date range
  startDate DateTime?
  endDate   DateTime?

  // Report content
  content Json
  summary String? @db.Text

  status ReportStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
}

enum ReportType {
  REVENUE_SUMMARY
  PRODUCT_ANALYSIS
  CUSTOMER_INSIGHTS
  FULL_ANALYSIS
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}
